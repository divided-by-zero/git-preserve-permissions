#!/bin/bash
git preserve-permissions --check
return_code="$?"
if [ "${return_code}" != "0" ]; then
    dbfile=$(git config --bool --get preserve-permissions.file)
    autosave=$(git config --bool --get preserve-permissions.autosave)
    autosavePatch=$(git config --bool --get preserve-permissions.autosavePatch)
    [ -z "${dbfile}" ] && dbfile=".git-preserve-permissions"
    [ -z "${autosave}" ] && autosave="false"
    [ -z "${autosavePatch}" ] && autosavePatch="true"
    if [ "${autosave}" = "false" ]; then
        echo "Execute 'git preserve-permissions --save' to save new permissions"
        echo "Execute 'git preserve-permissions --restore' to restore old permissions"
    elif [ "${autosavePatch}" = "true" ]; then
        git preserve-permissions --save
        exec < /dev/tty
        git add -p "${dbfile}"
        echo "Permissions saved, please redo your commit"
    else
        git preserve-permissions --save
        git add "${dbfile}"
        echo "Permissions saved, please redo your commit"
    fi
    exit ${return_code}
fi
